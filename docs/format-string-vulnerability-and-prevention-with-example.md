# 格式化字符串漏洞及防范举例

> 原文:[https://www . geesforgeks . org/format-string-漏洞与防范-示例/](https://www.geeksforgeeks.org/format-string-vulnerability-and-prevention-with-example/)

格式字符串是包含文本和格式参数的 ASCII 字符串。

**示例:**

```
// A statement with format string
printf("my name is : %s\n", "Akash");

// Output
// My name is : Akash

```

有几种格式字符串在 C 和许多其他编程语言中指定输出，但我们的重点是 C。

格式字符串漏洞是一类利用容易避免的程序员错误的 bug。如果程序员将攻击者控制的缓冲区作为参数传递给 printf(或任何相关函数，包括 sprintf、fprintf 等)，攻击者就可以对任意内存地址执行写操作。以下程序包含这样的错误:

```
// A simple C program with format
// string vulnerability
#include<stdio.h>

int main(int argc, char** argv)
{
    char buffer[100];
    strncpy(buffer, argv[1], 100);

    // We are passing command line
    // argument to printf
    printf(buffer);

    return 0;
}
```

由于 printf 的参数数量可变，因此它必须使用格式字符串来确定参数的数量。在上面的例子中，攻击者可以传递字符串“% p % p % p % p % p % p % p % p % p % p % p % p % p % p % p % p % p”并欺骗 printf 认为它有 15 个参数。它会天真地打印堆栈上接下来的 15 个地址，认为它们是它的论点:

```
$ ./a.out "%p %p %p %p %p %p %p %p %p %p %p %p %p %p %p"
0xffffdddd 0x64 0xf7ec1289 0xffffdbdf 0xffffdbde (nil) 0xffffdcc4 0xffffdc64 (nil) 0x25207025 0x70252070 0x20702520 0x25207025 0x70252070 0x20702520

```

在堆栈上大约有 10 个参数时，我们可以看到 0x252070 的重复模式–这些是我们在堆栈上的%ps！我们从 AAAA 开始，更清楚地看到这一点:

```
$ ./a.out "AAAA%p %p %p %p %p %p %p %p %p %p"
AAAA0xffffdde8 0x64 0xf7ec1289 0xffffdbef 0xffffdbee (nil) 0xffffdcd4 0xffffdc74 (nil) 0x41414141

```

0x41414141 是 AAAA 的十六进制表示。我们现在有一种方法可以将任意值(在本例中，我们将 0x41414141)作为参数传递给 printf。此时，我们将利用另一个格式字符串特性:在格式说明符中，我们还可以选择一个特定的参数。例如，printf("%2$x "，1，2，3)将打印 2。一般来说，我们可以通过 printf("%$x ")为 printf 选择任意参数。在我们的例子中，我们看到 0x41414141 是 printf 的第 10 个参数，因此我们可以简化字符串 1:

```
$ ./a.out 'AAAA%10$p'
AAAA0x41414141

```

**防止格式字符串漏洞**

*   始终将格式字符串指定为程序的一部分，而不是输入。大多数格式字符串漏洞都是通过将“%s”指定为格式字符串而不是将数据字符串用作格式字符串来解决的
*   如果可能，将格式字符串设为常量。提取所有变量部分作为调用的其他参数。一些国际化库很难做到
*   如果以上两种做法都不可行，使用 [Format_Guard](https://www.usenix.org/legacy/events/sec01/full_papers/cowanbarringer/cowanbarringer.pdf) 等防御手段。在设计时很少见。也许是继续使用遗留应用程序和降低成本的一种方法。增强对第三方应用程序安全的信任

**参考文献**T2[https://www.owasp.org/index.php/Format_string_attack](https://www.owasp.org/index.php/Format_string_attack)T5[https://www.exploit-db.com/docs/28476.pdf](https://www.exploit-db.com/docs/28476.pdf)

本文由**阿卡什·莎兰**供稿。如果你喜欢 GeeksforGeeks 并想投稿，你也可以使用[contribute.geeksforgeeks.org](http://www.contribute.geeksforgeeks.org)写一篇文章或者把你的文章邮寄到 contribute@geeksforgeeks.org。看到你的文章出现在极客博客主页上，帮助其他极客。

如果你发现任何不正确的地方，或者你想分享更多关于上面讨论的话题的信息，请写评论。